// Prisma Schema for Predicted Press
// Using SQLite for development, easily switch to PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// MARKETS - Synced from Polymarket
// ==========================================

model Market {
  id              String    @id
  title           String
  slug            String    @unique
  probability     Int       // 0-100
  volume          Float
  liquidity       Float
  endDate         DateTime?
  category        String
  source          String    @default("polymarket")

  // Price history tracking
  priceHistory    PricePoint[]

  // Related content
  articles        Article[]
  bounties        Bounty[]

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastSyncedAt    DateTime  @default(now())
  
  // Staleness tracking - probability at last article generation
  lastArticleProbability  Int?
  lastArticleGeneratedAt  DateTime?
}

model PricePoint {
  id          String   @id @default(cuid())
  marketId    String
  market      Market   @relation(fields: [marketId], references: [id])
  probability Int
  volume      Float
  timestamp   DateTime @default(now())

  @@index([marketId, timestamp])
}

// ==========================================
// ARTICLES - Editorial content
// ==========================================

model Article {
  id            String   @id @default(cuid())
  slug          String   @unique
  headline      String
  subheadline   String?
  excerpt       String
  content       String   // Markdown content
  category      String

  // Linked market
  marketId      String?
  market        Market?  @relation(fields: [marketId], references: [id])

  // Author info
  authorId      String?
  author        Author?  @relation(fields: [authorId], references: [id])

  // Editorial workflow
  status        ArticleStatus @default(DRAFT)
  publishedAt   DateTime?

  // AI generation tracking
  aiGenerated   Boolean  @default(false)
  aiDraftId     String?

  // Metrics
  views         Int      @default(0)
  affiliateClicks Int    @default(0)

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // From bounty?
  bountyId      String?  @unique
  bounty        Bounty?  @relation(fields: [bountyId], references: [id])
  
  // Staleness tracking - article chain/versioning
  probabilityAtGeneration Int?
  version                 Int     @default(1)
  parentArticleId         String?
  parentArticle           Article? @relation("ArticleChain", fields: [parentArticleId], references: [id])
  childArticles           Article[] @relation("ArticleChain")
  isLatest                Boolean @default(true)
}

enum ArticleStatus {
  DRAFT
  AI_DRAFT
  IN_REVIEW
  REVISION_REQUESTED
  APPROVED
  PUBLISHED
  ARCHIVED
}

// ==========================================
// AUTHORS / JOURNALISTS
// ==========================================

model Author {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  bio           String?
  avatarUrl     String?
  role          String   @default("Contributor")

  // Performance
  reputation    Float    @default(0)
  articlesCount Int      @default(0)
  totalEarnings Float    @default(0)
  completionRate Float   @default(100)

  // Tier system
  tier          AuthorTier @default(CONTRIBUTOR)

  // Specialties (JSON array of categories)
  specialties   String   @default("[]")

  // Payment info (encrypted in production)
  paymentMethod String?
  paymentDetails String?

  // Content
  articles      Article[]
  bounties      Bounty[]

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum AuthorTier {
  CONTRIBUTOR
  VERIFIED
  SENIOR
  EDITOR
  ADMIN
}

// ==========================================
// BOUNTY SYSTEM
// ==========================================

model Bounty {
  id            String   @id @default(cuid())
  headline      String
  description   String?

  // Linked market
  marketId      String
  market        Market   @relation(fields: [marketId], references: [id])

  // Reward
  baseReward    Float
  bonusPool     Float    @default(0)

  // Requirements (JSON)
  requirements  String   @default("[]")

  // Status
  status        BountyStatus @default(OPEN)
  deadline      DateTime

  // Assignment
  claimedById   String?
  claimedBy     Author?  @relation(fields: [claimedById], references: [id])
  claimedAt     DateTime?

  // AI draft
  aiDraft       String?
  aiDraftCreatedAt DateTime?

  // Result
  article       Article?
  completedAt   DateTime?
  paidOut       Boolean  @default(false)
  paidAmount    Float?

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Priority/heat
  priority      BountyPriority @default(NORMAL)
}

enum BountyStatus {
  OPEN
  CLAIMED
  IN_PROGRESS
  SUBMITTED
  IN_REVIEW
  REVISION_REQUESTED
  APPROVED
  PAID
  EXPIRED
  CANCELLED
}

enum BountyPriority {
  NORMAL
  TRENDING
  URGENT
  PREMIUM
}

// ==========================================
// SUBSCRIBERS
// ==========================================

model Subscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  tier          SubscriberTier @default(FREE)

  // Preferences
  categories    String   @default("[]")
  alertThreshold Int     @default(5)

  // Stripe
  stripeCustomerId String?
  stripeSubscriptionId String?

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum SubscriberTier {
  FREE
  PRO
  API
}

// ==========================================
// ANALYTICS
// ==========================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  type      String
  articleId String?
  marketId  String?
  metadata  String?
  timestamp DateTime @default(now())

  @@index([type, timestamp])
  @@index([articleId])
}
